WITH 

BASE AS (
  SELECT *
  FROM ANALYTICS.SIGMA_WRITE.CONTRACT_EXECUTION_DATASET
  WHERE 1=1    
    AND WITHIN_CONTRACT_DATES = TRUE  -- REMOVES CRAPPY DATA THAT SHOULD BE EXCLUDED
    AND (
    CASE 
      WHEN {{ Pickup-Date-Controller }}:start IS NOT NULL 
      AND {{ Pickup-Date-Controller }}:end IS NOT NULL 
      THEN PICKUP_DATE:: DATE >= {{ Pickup-Date-Controller }}:start :: TIMESTAMP :: DATE 
      AND PICKUP_DATE:: DATE <= {{ Pickup-Date-Controller }}:end :: TIMESTAMP :: DATE END  -- FOR DATES 'BETWEEN'
    OR CASE 
      WHEN {{ Pickup-Date-Controller }}:start IS NULL 
      AND {{ Pickup-Date-Controller }}:end IS NOT NULL 
      THEN PICKUP_DATE:: DATE <= {{ Pickup-Date-Controller }}:end :: TIMESTAMP :: DATE END  -- FOR DATES 'BEFORE'
    OR CASE 
      WHEN {{ Pickup-Date-Controller }}:start IS NOT NULL 
      AND {{ Pickup-Date-Controller }}:end IS NULL 
      THEN PICKUP_DATE:: DATE >= {{ Pickup-Date-Controller }}:start :: TIMESTAMP :: DATE END  -- FOR DATES 'AFTER'
    )
),

BASECALCS AS (
  SELECT
     CONTRACT_KEY
    ,S_NUMBER
    ,PICKUP_DATE
    ,VOLUME
    ,FREQUENCY
    ,EFFECTIVE_CONTRACT_START_DATE
    ,EFFECTIVE_CONTRACT_END_DATE
    ,DAY(PICKUP_DATE) AS DAY_OF_PICKUPDATE
    ,WEEK(PICKUP_DATE) AS WEEK_OF_PICKUPDATE
    ,MONTH(PICKUP_DATE) AS MONTH_OF_PICKUPDATE
    ,YEAR(PICKUP_DATE) AS YEAR_OF_PICKUPDATE
    -- ,CEIL(MONTHS_BETWEEN(EFFECTIVE_CONTRACT_END_DATE, EFFECTIVE_CONTRACT_START_DATE), 0) AS COUNT_OF_MONTHS
    ,SCHEDULED_CONTRACT_START_DATE
    ,SCHEDULED_CONTRACT_END_DATE
    -- ,CEIL(DATEDIFF(WEEK, SCHEDULED_CONTRACT_START_DATE, SCHEDULED_CONTRACT_END_DATE), 0) AS COUNT_OF_WEEKS -- COUNT_OF_SCHEDULED_WEEKS
    ,CEIL(MONTHS_BETWEEN(SCHEDULED_CONTRACT_END_DATE, SCHEDULED_CONTRACT_START_DATE), 0) AS COUNT_OF_MONTHS -- COUNT_OF_SCHEDULED_MONTHS

    ,OTP
    ,OTD

--DAILY
    ,COUNT(S_NUMBER) OVER (PARTITION BY CONTRACT_KEY, DAY_OF_PICKUPDATE, WEEK_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS TOTAL_LOADS_DAILY
    ,COUNT_IF(CONTRACT_CARRIER_FULFILLED = TRUE) OVER (PARTITION BY CONTRACT_KEY, DAY_OF_PICKUPDATE, WEEK_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS EXECUTED_LOADS_DAILY
    ,COUNT_IF(CONTRACT_CARRIER_FULFILLED = FALSE) OVER (PARTITION BY CONTRACT_KEY, DAY_OF_PICKUPDATE, WEEK_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS MISSED_LOADS_DAILY
    ,SUM(REVENUE) OVER (PARTITION BY CONTRACT_KEY, DAY_OF_PICKUPDATE, WEEK_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS TOTAL_REVENUE_DAILY
    ,SUM(CASE WHEN CONTRACT_CARRIER_FULFILLED = TRUE THEN REVENUE END) OVER (PARTITION BY CONTRACT_KEY, DAY_OF_PICKUPDATE, WEEK_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS EXECUTED_REVENUE_DAILY
    ,SUM(CASE WHEN CONTRACT_CARRIER_FULFILLED = FALSE THEN REVENUE END) OVER (PARTITION BY CONTRACT_KEY, DAY_OF_PICKUPDATE, WEEK_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS MISSED_REVENUE_DAILY
    ,SUM(GP) OVER (PARTITION BY CONTRACT_KEY, DAY_OF_PICKUPDATE, WEEK_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS TOTAL_GP_DAILY
    ,SUM(CASE WHEN CONTRACT_CARRIER_FULFILLED = TRUE THEN GP END) OVER (PARTITION BY CONTRACT_KEY, DAY_OF_PICKUPDATE, WEEK_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS EXECUTED_GP_DAILY
    ,SUM(CASE WHEN CONTRACT_CARRIER_FULFILLED = FALSE THEN GP END) OVER (PARTITION BY CONTRACT_KEY, DAY_OF_PICKUPDATE, WEEK_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS MISSED_GP_DAILY
    ,COUNT_IF(CONTRACT_CARRIER_FULFILLED = TRUE AND OTP = TRUE) OVER (PARTITION BY CONTRACT_KEY, DAY_OF_PICKUPDATE, WEEK_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS OTP_DAILY
    ,COUNT_IF(CONTRACT_CARRIER_FULFILLED = TRUE AND OTD = TRUE) OVER (PARTITION BY CONTRACT_KEY, DAY_OF_PICKUPDATE, WEEK_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS OTD_DAILY

--WEEKLY
    ,COUNT(S_NUMBER) OVER (PARTITION BY CONTRACT_KEY, WEEK_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS TOTAL_LOADS_WEEKLY
    ,COUNT_IF(CONTRACT_CARRIER_FULFILLED = TRUE) OVER (PARTITION BY CONTRACT_KEY, WEEK_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS EXECUTED_LOADS_WEEKLY
    ,COUNT_IF(CONTRACT_CARRIER_FULFILLED = FALSE) OVER (PARTITION BY CONTRACT_KEY, WEEK_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS MISSED_LOADS_WEEKLY
    ,SUM(REVENUE) OVER (PARTITION BY CONTRACT_KEY, WEEK_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS TOTAL_REVENUE_WEEKLY
    ,SUM(CASE WHEN CONTRACT_CARRIER_FULFILLED = TRUE THEN REVENUE END) OVER (PARTITION BY CONTRACT_KEY, WEEK_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS EXECUTED_REVENUE_WEEKLY
    ,SUM(CASE WHEN CONTRACT_CARRIER_FULFILLED = FALSE THEN REVENUE END) OVER (PARTITION BY CONTRACT_KEY, WEEK_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS MISSED_REVENUE_WEEKLY
    ,SUM(GP) OVER (PARTITION BY CONTRACT_KEY, WEEK_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS TOTAL_GP_WEEKLY
    ,SUM(CASE WHEN CONTRACT_CARRIER_FULFILLED = TRUE THEN GP END) OVER (PARTITION BY CONTRACT_KEY, WEEK_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS EXECUTED_GP_WEEKLY
    ,SUM(CASE WHEN CONTRACT_CARRIER_FULFILLED = FALSE THEN GP END) OVER (PARTITION BY CONTRACT_KEY, WEEK_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS MISSED_GP_WEEKLY
    ,COUNT_IF(CONTRACT_CARRIER_FULFILLED = TRUE AND OTP = TRUE) OVER (PARTITION BY CONTRACT_KEY, WEEK_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS OTP_WEEKLY
    ,COUNT_IF(CONTRACT_CARRIER_FULFILLED = TRUE AND OTD = TRUE) OVER (PARTITION BY CONTRACT_KEY, WEEK_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS OTD_WEEKLY

--MONTHLY
    ,COUNT(S_NUMBER) OVER (PARTITION BY CONTRACT_KEY, MONTH_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS TOTAL_LOADS_MONTHLY
    ,COUNT_IF(CONTRACT_CARRIER_FULFILLED = TRUE) OVER (PARTITION BY CONTRACT_KEY, MONTH_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS EXECUTED_LOADS_MONTHLY
    ,COUNT_IF(CONTRACT_CARRIER_FULFILLED = FALSE) OVER (PARTITION BY CONTRACT_KEY, MONTH_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS MISSED_LOADS_MONTHLY
    ,SUM(REVENUE) OVER (PARTITION BY CONTRACT_KEY, MONTH_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS TOTAL_REVENUE_MONTHLY
    ,SUM(CASE WHEN CONTRACT_CARRIER_FULFILLED = TRUE THEN REVENUE END) OVER (PARTITION BY CONTRACT_KEY, MONTH_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS EXECUTED_REVENUE_MONTHLY
    ,SUM(CASE WHEN CONTRACT_CARRIER_FULFILLED = FALSE THEN REVENUE END) OVER (PARTITION BY CONTRACT_KEY, MONTH_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS MISSED_REVENUE_MONTHLY
    ,SUM(GP) OVER (PARTITION BY CONTRACT_KEY, MONTH_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS TOTAL_GP_MONTHLY
    ,SUM(CASE WHEN CONTRACT_CARRIER_FULFILLED = TRUE THEN GP END) OVER (PARTITION BY CONTRACT_KEY, MONTH_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS EXECUTED_GP_MONTHLY
    ,SUM(CASE WHEN CONTRACT_CARRIER_FULFILLED = FALSE THEN GP END) OVER (PARTITION BY CONTRACT_KEY, MONTH_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS MISSED_GP_MONTHLY
    ,COUNT_IF(CONTRACT_CARRIER_FULFILLED = TRUE AND OTP = TRUE) OVER (PARTITION BY CONTRACT_KEY, MONTH_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS OTP_MONTHLY
    ,COUNT_IF(CONTRACT_CARRIER_FULFILLED = TRUE AND OTD = TRUE) OVER (PARTITION BY CONTRACT_KEY, MONTH_OF_PICKUPDATE, YEAR_OF_PICKUPDATE) AS OTD_MONTHLY

--TOTAL
    ,COUNT(S_NUMBER) OVER (PARTITION BY CONTRACT_KEY) AS TOTAL_LOADS_TOTAL
    ,COUNT_IF(CONTRACT_CARRIER_FULFILLED = TRUE) OVER (PARTITION BY CONTRACT_KEY) AS EXECUTED_LOADS_TOTAL
    ,COUNT_IF(CONTRACT_CARRIER_FULFILLED = FALSE) OVER (PARTITION BY CONTRACT_KEY) AS MISSED_LOADS_TOTAL

--EXECUTION CALCULATIONS BASED ON FREQUENCY
    ,CASE  
      WHEN FREQUENCY IN ('Total', 'Yearly', 'Quarterly') AND TOTAL_LOADS_MONTHLY > DIV0(VOLUME, COUNT_OF_MONTHS) THEN DIV0(EXECUTED_LOADS_MONTHLY, DIV0(VOLUME, COUNT_OF_MONTHS))
      WHEN FREQUENCY IN ('Total', 'Yearly', 'Quarterly') THEN DIV0(EXECUTED_LOADS_MONTHLY, TOTAL_LOADS_MONTHLY)
        --FOR TOTAL FREQ. TYPES WE CAN ALSO DIVIDE BY THE TOTAL_LOADS_TOTAL SO THEY ARE ONLY JUDGED ON WHAT HAS MATERIALIZED
      WHEN FREQUENCY = 'Monthly' AND TOTAL_LOADS_MONTHLY > VOLUME THEN DIV0(EXECUTED_LOADS_MONTHLY, VOLUME)
      WHEN FREQUENCY = 'Monthly' THEN DIV0(EXECUTED_LOADS_MONTHLY, TOTAL_LOADS_MONTHLY)
      WHEN FREQUENCY = 'Weekly' AND TOTAL_LOADS_WEEKLY > VOLUME THEN DIV0(EXECUTED_LOADS_WEEKLY, VOLUME)
      WHEN FREQUENCY = 'Weekly' THEN DIV0(EXECUTED_LOADS_WEEKLY, TOTAL_LOADS_WEEKLY)
      WHEN FREQUENCY = 'Daily' AND TOTAL_LOADS_DAILY > VOLUME THEN DIV0(EXECUTED_LOADS_DAILY, VOLUME)
      WHEN FREQUENCY = 'Daily' THEN DIV0(EXECUTED_LOADS_DAILY, TOTAL_LOADS_DAILY)
      ELSE NULL
      END AS PERIOD_CONTRACT_PERFORMANCE

--CAP ALL PERFORMANCE METRICS AT 100% (1)
    ,CASE
      WHEN PERIOD_CONTRACT_PERFORMANCE > 1 THEN 1
      ELSE PERIOD_CONTRACT_PERFORMANCE
      END AS CAPPED_PERIOD_CONTRACT_PERFORMANCE

--ADDITIONAL METRIC, NOT SURE WE NEED IT
    ,CASE
      WHEN TOTAL_LOADS_TOTAL > VOLUME THEN ROUND(DIV0(EXECUTED_LOADS_TOTAL, VOLUME),2)  -- MORE THAN EXPECTED VOLUME
      ELSE ROUND(DIV0(EXECUTED_LOADS_TOTAL, TOTAL_LOADS_TOTAL),2)  -- LESS THAN EXPECTED VOLUME
      END AS SIMPLE_OVERALL_CONTRACT_PERFORMANCE

--OTP/OTD CALCULATIONS BASED ON FREQUENCY
    ,CASE
      WHEN FREQUENCY IN ('Total', 'Yearly', 'Quarterly', 'Monthly') THEN DIV0(OTP_MONTHLY, EXECUTED_LOADS_MONTHLY)
      WHEN FREQUENCY IN ('Weekly') THEN DIV0(OTP_WEEKLY, EXECUTED_LOADS_WEEKLY)
      WHEN FREQUENCY IN ('Daily') THEN DIV0(OTP_DAILY, EXECUTED_LOADS_DAILY)
      ELSE NULL
      END AS PERIOD_OTP_PERCENTAGE
    ,CASE
      WHEN FREQUENCY IN ('Total', 'Yearly', 'Quarterly', 'Monthly') THEN DIV0(OTD_MONTHLY, EXECUTED_LOADS_MONTHLY)
      WHEN FREQUENCY IN ('Weekly') THEN DIV0(OTD_WEEKLY, EXECUTED_LOADS_WEEKLY)
      WHEN FREQUENCY IN ('Daily') THEN DIV0(OTD_DAILY, EXECUTED_LOADS_DAILY)
      ELSE NULL
      END AS PERIOD_OTD_PERCENTAGE

  FROM BASE
),

--EACH FREQUENCY TYPE GETS TWO CTE'S, ONE FOR THE PERIOD-BASED CALCULATIONS AND ONE TO SUMMARIZE AND NORMALIZE THE FIELDS

MIDCALC_DAILY AS (
  SELECT
     CONTRACT_KEY
    ,DAY_OF_PICKUPDATE
    ,WEEK_OF_PICKUPDATE
    ,YEAR_OF_PICKUPDATE
    ,MAX(CAPPED_PERIOD_CONTRACT_PERFORMANCE) AS DAILY_PERFORMANCE_SCORE
    ,MAX(TOTAL_LOADS_DAILY) AS DAILY_TOTAL_LOADS
    ,MAX(EXECUTED_LOADS_DAILY) AS DAILY_EXECUTED_LOADS
    ,MAX(MISSED_LOADS_DAILY) AS DAILY_MISSED_LOADS
    ,MAX(TOTAL_REVENUE_DAILY) AS DAILY_TOTAL_REVENUE
    ,MAX(EXECUTED_REVENUE_DAILY) AS DAILY_EXECUTED_REVENUE
    ,MAX(MISSED_REVENUE_DAILY) AS DAILY_MISSED_REVENUE
    ,MAX(TOTAL_GP_DAILY) AS DAILY_TOTAL_GP
    ,MAX(EXECUTED_GP_DAILY) AS DAILY_EXECUTED_GP
    ,MAX(MISSED_GP_DAILY) AS DAILY_MISSED_GP
    ,MAX(PERIOD_OTP_PERCENTAGE) AS DAILY_EXECUTED_OTP_PERCENT
    ,MAX(PERIOD_OTD_PERCENTAGE) AS DAILY_EXECUTED_OTD_PERCENT
  FROM BASECALCS
  WHERE FREQUENCY = 'Daily'
  GROUP BY 
     CONTRACT_KEY
    ,DAY_OF_PICKUPDATE
    ,WEEK_OF_PICKUPDATE
    ,YEAR_OF_PICKUPDATE
),

DAILY_AVG AS (
  SELECT
    CONTRACT_KEY
    ,AVG(DAILY_PERFORMANCE_SCORE) AS EXECUTION_SCORE
    ,SUM(DAILY_TOTAL_LOADS) AS TOTAL_LOADS
    ,SUM(DAILY_EXECUTED_LOADS) AS TOTAL_EXECUTED_LOADS
    ,SUM(DAILY_MISSED_LOADS) AS TOTAL_MISSED_LOADS
    ,SUM(DAILY_TOTAL_REVENUE) AS TOTAL_REVENUE
    ,SUM(DAILY_EXECUTED_REVENUE) AS TOTAL_EXECUTED_REVENUE
    ,SUM(DAILY_MISSED_REVENUE) AS TOTAL_MISSED_REVENUE
    ,SUM(DAILY_TOTAL_GP) AS TOTAL_GP
    ,SUM(DAILY_EXECUTED_GP) AS TOTAL_EXECUTED_GP
    ,SUM(DAILY_MISSED_GP) AS TOTAL_MISSED_GP
    ,AVG(DAILY_EXECUTED_OTP_PERCENT) AS EXECUTED_OTP_PERCENT
    ,AVG(DAILY_EXECUTED_OTD_PERCENT) AS EXECUTED_OTD_PERCENT
  FROM MIDCALC_DAILY
  GROUP BY CONTRACT_KEY
),

MIDCALC_WEEKLY AS (
  SELECT
     CONTRACT_KEY
    ,WEEK_OF_PICKUPDATE
    ,YEAR_OF_PICKUPDATE
    ,MAX(CAPPED_PERIOD_CONTRACT_PERFORMANCE) AS WEEKLY_PERFORMANCE_SCORE
    ,MAX(TOTAL_LOADS_WEEKLY) AS WEEKLY_TOTAL_LOADS
    ,MAX(EXECUTED_LOADS_WEEKLY) AS WEEKLY_EXECUTED_LOADS
    ,MAX(MISSED_LOADS_WEEKLY) AS WEEKLY_MISSED_LOADS
    ,MAX(TOTAL_REVENUE_WEEKLY) AS WEEKLY_TOTAL_REVENUE
    ,MAX(EXECUTED_REVENUE_WEEKLY) AS WEEKLY_EXECUTED_REVENUE
    ,MAX(MISSED_REVENUE_WEEKLY) AS WEEKLY_MISSED_REVENUE
    ,MAX(TOTAL_GP_WEEKLY) AS WEEKLY_TOTAL_GP
    ,MAX(EXECUTED_GP_WEEKLY) AS WEEKLY_EXECUTED_GP
    ,MAX(MISSED_GP_WEEKLY) AS WEEKLY_MISSED_GP
    ,MAX(PERIOD_OTP_PERCENTAGE) AS WEEKLY_EXECUTED_OTP_PERCENT
    ,MAX(PERIOD_OTD_PERCENTAGE) AS WEEKLY_EXECUTED_OTD_PERCENT
  FROM BASECALCS
  WHERE FREQUENCY = 'Weekly'
  GROUP BY 
     CONTRACT_KEY
    ,WEEK_OF_PICKUPDATE
    ,YEAR_OF_PICKUPDATE
),

WEEKLY_AVG AS (
  SELECT
    CONTRACT_KEY
    ,AVG(WEEKLY_PERFORMANCE_SCORE) AS EXECUTION_SCORE
    ,SUM(WEEKLY_TOTAL_LOADS) AS TOTAL_LOADS
    ,SUM(WEEKLY_EXECUTED_LOADS) AS TOTAL_EXECUTED_LOADS
    ,SUM(WEEKLY_MISSED_LOADS) AS TOTAL_MISSED_LOADS
    ,SUM(WEEKLY_TOTAL_REVENUE) AS TOTAL_REVENUE
    ,SUM(WEEKLY_EXECUTED_REVENUE) AS TOTAL_EXECUTED_REVENUE
    ,SUM(WEEKLY_MISSED_REVENUE) AS TOTAL_MISSED_REVENUE
    ,SUM(WEEKLY_TOTAL_GP) AS TOTAL_GP
    ,SUM(WEEKLY_EXECUTED_GP) AS TOTAL_EXECUTED_GP
    ,SUM(WEEKLY_MISSED_GP) AS TOTAL_MISSED_GP
    ,AVG(WEEKLY_EXECUTED_OTP_PERCENT) AS EXECUTED_OTP_PERCENT
    ,AVG(WEEKLY_EXECUTED_OTD_PERCENT) AS EXECUTED_OTD_PERCENT
  FROM MIDCALC_WEEKLY
  GROUP BY CONTRACT_KEY
),

MIDCALC_MONTHLY AS (
  SELECT
     CONTRACT_KEY
    ,MONTH_OF_PICKUPDATE
    ,YEAR_OF_PICKUPDATE
    ,MAX(CAPPED_PERIOD_CONTRACT_PERFORMANCE) AS MONTHLY_PERFORMANCE_SCORE
    ,MAX(TOTAL_LOADS_MONTHLY) AS MONTHLY_TOTAL_LOADS
    ,MAX(EXECUTED_LOADS_MONTHLY) AS MONTHLY_EXECUTED_LOADS
    ,MAX(MISSED_LOADS_MONTHLY) AS MONTHLY_MISSED_LOADS
    ,MAX(TOTAL_REVENUE_MONTHLY) AS MONTHLY_TOTAL_REVENUE
    ,MAX(EXECUTED_REVENUE_MONTHLY) AS MONTHLY_EXECUTED_REVENUE
    ,MAX(MISSED_REVENUE_MONTHLY) AS MONTHLY_MISSED_REVENUE
    ,MAX(TOTAL_GP_MONTHLY) AS MONTHLY_TOTAL_GP
    ,MAX(EXECUTED_GP_MONTHLY) AS MONTHLY_EXECUTED_GP
    ,MAX(MISSED_GP_MONTHLY) AS MONTHLY_MISSED_GP
    ,MAX(PERIOD_OTP_PERCENTAGE) AS MONTHLY_EXECUTED_OTP_PERCENT
    ,MAX(PERIOD_OTD_PERCENTAGE) AS MONTHLY_EXECUTED_OTD_PERCENT
  FROM BASECALCS
  WHERE FREQUENCY IN ('Monthly', 'Quarterly', 'Yearly', 'Total')
  GROUP BY 
   CONTRACT_KEY
  ,MONTH_OF_PICKUPDATE
  ,YEAR_OF_PICKUPDATE
),

MONTHLY_AVG AS (
  SELECT
    CONTRACT_KEY
    ,AVG(MONTHLY_PERFORMANCE_SCORE) AS EXECUTION_SCORE
    ,SUM(MONTHLY_TOTAL_LOADS) AS TOTAL_LOADS
    ,SUM(MONTHLY_EXECUTED_LOADS) AS TOTAL_EXECUTED_LOADS
    ,SUM(MONTHLY_MISSED_LOADS) AS TOTAL_MISSED_LOADS
    ,SUM(MONTHLY_TOTAL_REVENUE) AS TOTAL_REVENUE
    ,SUM(MONTHLY_EXECUTED_REVENUE) AS TOTAL_EXECUTED_REVENUE
    ,SUM(MONTHLY_MISSED_REVENUE) AS TOTAL_MISSED_REVENUE
    ,SUM(MONTHLY_TOTAL_GP) AS TOTAL_GP
    ,SUM(MONTHLY_EXECUTED_GP) AS TOTAL_EXECUTED_GP
    ,SUM(MONTHLY_MISSED_GP) AS TOTAL_MISSED_GP
    ,AVG(MONTHLY_EXECUTED_OTP_PERCENT) AS EXECUTED_OTP_PERCENT
    ,AVG(MONTHLY_EXECUTED_OTD_PERCENT) AS EXECUTED_OTD_PERCENT
  FROM MIDCALC_MONTHLY
  GROUP BY CONTRACT_KEY
),

--UNION THE FOUR TYPES TOGETHER TO HAVE A SINGLE LIST OF CONTRACTS AND EXECUTION SCORES

ALL_CONTRACT_SCORES AS (
  SELECT *
  FROM DAILY_AVG
  UNION
  SELECT *
  FROM WEEKLY_AVG
  UNION
  SELECT *
  FROM MONTHLY_AVG
),

--DISTINCT LIST OF ALL CONTRACTS FOR BASIC INFORMATION AS WELL AS TO CAPTURE THOSE WITH ZERO MATERIALIZATION

CONTRACT_INFO AS (
  SELECT DISTINCT
     CONTRACT_KEY
    ,CONTRACT_DETAILS
    ,CONTRACT_TYPE
    ,CARRIER_OWNER
    ,REPORTING_NOTES
    ,LPD
    ,VOLUME
    ,FREQUENCY
    ,EFFECTIVE_CONTRACT_START_DATE
    ,EFFECTIVE_CONTRACT_END_DATE
    ,TERMINATED
    ,CONTRACT_TERMINATION_REASON_CODE
    ,NOTES AS MEG_NOTES
    ,CARRIER_RATE
    ,RATE_TYPE
    ,TOTAL_ESTIMATED_VOLUME
    ,TOTAL_ESTIMATED_REVENUE
    ,TOTAL_ESTIMATED_GP
    ,CONTRACT_SHIPPER_NAME
    ,MEG_CARRIER_NAME
    ,CONTRACT_LIVE AS CONTRACT_LIVE_TODAY
    ,CASE WHEN PCR.CURRENT_PC IS NULL THEN FALSE ELSE PCR.CURRENT_PC END AS IS_CURRENT_PC
  FROM ANALYTICS.SIGMA_WRITE.CONTRACT_EXECUTION_DATASET CED
  LEFT JOIN ANALYTICS.SIGMA_WRITE.PREMIER_CARRIER_RECORD PCR ON CED.MEG_CARRIER_DOT = PCR.PC_DOT
),

--FINAL JOINS AND ROUNDING

FINAL AS (
  SELECT
     ROUND(ALL_CONTRACT_SCORES.EXECUTION_SCORE,3) AS RAW_EXECUTION_SCORE
    ,CASE WHEN TOTAL_EXECUTED_LOADS >= TOTAL_ESTIMATED_VOLUME THEN 1 ELSE RAW_EXECUTION_SCORE END AS EXECUTION_SCORE
    ,TOTAL_LOADS
    ,TOTAL_REVENUE
    ,TOTAL_GP
    ,TOTAL_EXECUTED_LOADS
    ,TOTAL_EXECUTED_REVENUE
    ,TOTAL_EXECUTED_GP
    ,ROUND(EXECUTED_OTP_PERCENT,3) AS EXECUTED_OTP_SCORE
    ,ROUND(EXECUTED_OTD_PERCENT,3) AS EXECUTED_OTD_SCORE
    ,TOTAL_MISSED_LOADS
    ,TOTAL_MISSED_REVENUE
    ,TOTAL_MISSED_GP
    ,CONTRACT_INFO.*
  FROM CONTRACT_INFO
  LEFT JOIN ALL_CONTRACT_SCORES ON CONTRACT_INFO.CONTRACT_KEY = ALL_CONTRACT_SCORES.CONTRACT_KEY
)

SELECT *
FROM 
  -- BASE  -- SHIPMENT LEVEL INFO
  -- BASECALCS  -- SHIPMENT LEVEL INFO WITH WINDOWS FUNCTION AGGREGATIONS
  
  -- MIDCALC_DAILY
  -- DAILY_AVG
  -- MIDCALC_WEEKLY
  -- WEEKLY_AVG
  -- MIDCALC_MONTHLY
  -- MONTHLY_AVG
  
  -- ALL_CONTRACT_SCORES
  -- CONTRACT_INFO
  FINAL
  
  --DNU-- MIDCALC_TOTAL
  --DNU-- TOTAL_CALCS
WHERE 1=1
  -- AND CONTRACT_KEY = 'C11025627-2866732' -- YEARLY
  -- AND CONTRACT_KEY ='82DC919F-C8AA-4250-85A5-ADB52E6407D3-919149' -- TOTAL
  -- AND CONTRACT_KEY = 'C11063142-2475713'  -- QUARTERLY
  -- AND CONTRACT_KEY = 'C11056107-2890110' -- MONTHLY
  -- AND CONTRACT_KEY = 'C11021589-3099638' -- WEEKLY
  -- AND CONTRACT_KEY = 'C11074349-2115435' --DAILY
  
  -- AND CONTRACT_KEY = 'C8F2EC35-4A65-40A5-88FD-ACE5C903E450-75250' -- sage
  -- AND DAY_OF_PICKUPDATE = 18
  -- AND PICKUP_DATE = DATEFROMPARTS(2023,05,26)
