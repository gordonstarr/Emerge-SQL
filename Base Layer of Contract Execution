WITH MEG AS(
  SELECT 
     CMP_ID
    ,TRY_CAST(CARRIER_DOT AS INT) AS CARRIER_DOT
    ,CARRIER_NAME
    ,TRY_CAST(SCHEDULED_CONTRACT_START_DATE AS DATE) AS SCHEDULED_CONTRACT_START_DATE
    ,TRY_CAST(SCHEDULED_CONTRACT_END_DATE AS DATE) AS SCHEDULED_CONTRACT_END_DATE
    ,TRY_CAST(CONTRACT_TERMINATION_DATE AS DATE) AS CONTRACT_TERMINATION_DATE
    ,TRY_CAST(EFFECTIVE_CONTRACT_START_DATE AS DATE) AS EFFECTIVE_CONTRACT_START_DATE
    ,TRY_CAST(EFFECTIVE_CONTRACT_END_DATE AS DATE) AS EFFECTIVE_CONTRACT_END_DATE
    ,OWNED_OR_UNOWNED_CONTRACT
    ,TRY_CAST(LPD AS FLOAT) AS LPD
    ,TRY_CAST(VOLUME AS FLOAT) AS VOLUME
    ,FREQUENCY
    ,SHIPPER_NAME
    ,SOURCING_TEAM
    ,NEW_REPORTING_CONCAT
    ,OPERATIONAL_PREFERENCES_NOTES
    ,ROUND(TRY_CAST(EXPECTED_GP_PER_LOAD AS FLOAT),2) AS EXPECTED_GP_PER_LOAD
    ,CONTRACT_TERMINATED
    ,CONTRACT_TERMINATION_REASON_CODE
    ,NOTES
    ,CARRIER_RATE
    ,RATE_TYPE
    ,TRY_CAST(TOTAL_CONTRACT_VOLUME AS FLOAT) AS TOTAL_CONTRACT_VOLUME
    ,TRY_CAST(ESTIMATED_TOTAL_REVENUE AS FLOAT) AS ESTIMATED_TOTAL_REVENUE
    ,TRY_CAST(ESTIMATED_TOTAL_GP AS FLOAT) AS ESTIMATED_TOTAL_GP

    ,CONCAT(CMP_ID,'-',CARRIER_DOT) AS CONTRACT_ID
  FROM FIVETRAN_DATABASE.GOOGLE_SHEETS.CMP_AWARD_TRACKING_2 M
  WHERE 
    1=1
    AND CMP_ID IS NOT NULL
    AND CONTRACT_STATUS = 'Accepted'
),

OMS AS(
  SELECT 
     O.*
    ,C.*
    ,CASE 
      WHEN O."Actual Pickup Date" IS NOT NULL THEN O."Actual Pickup Date"
      WHEN O."Actual Pickup Date" IS NULL AND O."Sch Pu Datetime Mst" IS NULL THEN O."Emerge Tender Accepted Datetime Mst"      
      WHEN O."Actual Pickup Date" IS NULL THEN O."Sch Pu Datetime Mst"
      END AS PICKUP_DATE
    ,CASE 
      WHEN O."Actual Pickup Date" IS NOT NULL THEN 'ACTUAL PICKUP DATE'
      WHEN O."Actual Pickup Date" IS NULL AND O."Sch Pu Datetime Mst" IS NULL THEN 'TENDER ACCEPTED DATE'    
      WHEN O."Actual Pickup Date" IS NULL THEN 'SCHEDULED PICKUP DATE'
      END AS PICKUP_DATE_TYPE
  FROM ANALYTICS.SIGMA_WRITE.VIEW_5S__OPERATIONAL_MASTER_SET_99B98617EADC4586AEE2C6FE1A7EB27C_MAT O
  LEFT JOIN ANALYTICS.SIGMA_WRITE.CONTRACTMATERIALIZATIONPAIRS C ON O."S Number" = C."SHIPMENT REFERENCE"
),

CARRIER_OWNERS AS(
  SELECT 
     TE.TRANSPORTATION_ENTITY_KEY
    ,TE.TRANSPORTATION_ENTITY_ID_BK
    ,TE.TRANSPORTATION_ENTITY_LEGALNAME AS CARRIER
    ,TE.TRANSPORTATION_ENTITY_DOTNUMBER AS DOT
    ,CO.FULL_NAME AS CARRIER_OWNER
  FROM MODELLEDZONE.PUBLIC.DIM_TRANSPORTATION_ENTITY TE
  INNER JOIN FIVETRAN_DATABASE.MONGO_PRODUCTION_BROKERAGETMS_ORGANIZATIONS.TRANSPORTATION_ORGANIZATION FTE on FTE.TRANSPORTATION_ENTITY_INTEGRATION_ID = TE.TRANSPORTATION_ENTITY_ID_BK
  LEFT JOIN MODELLEDZONE.PUBLIC.DIM_USER CO ON UPPER(CO.USER_GUID) = UPPER(FTE.CARRIER_OWNER_GUID)
)

SELECT
-- SHIPMENT INFO
   OMS."S Number" AS S_NUMBER
  ,CASE WHEN OMS."Shipper" IS NULL THEN MEG.SHIPPER_NAME ELSE OMS."Shipper" END AS SHIPPER
  ,OMS."Carrier" AS SHIPMENT_CARRIER
  ,OMS."Dot Number" AS SHIPMENT_CARRIER_DOT
  ,OMS.PICKUP_DATE
  ,OMS.PICKUP_DATE_TYPE
  ,OMS."Actual Pickup Datetime" AS ACTUAL_PICKUP_DATETIME
  ,OMS."Delivered Datetime Mst" AS DELIVERED_DATETIME_MST
  ,OMS."Otp" AS OTP
  ,OMS."Otd" AS OTD
  ,OMS."Tracking Type" AS TRACKING_TYPE
  ,IFF(OMS."Total Contract Rate Options">0,TRUE,FALSE) AS HAS_CONTRACT_RATE_OPTION

-- SHIPMENT INFO: MONEY
  ,OMS."Revenue" AS REVENUE
  ,OMS."Cost" AS COST
  ,OMS."Gp" AS GP
  ,EXPECTED_GP_PER_LOAD::FLOAT AS EXPECTED_GP_PER_LOAD
  ,ROUND("Gp" - EXPECTED_GP_PER_LOAD,2) AS GP_IMPLICATION

-- SHIPMENT INFO: BOUNCE
  ,OMS."Bounced" AS BOUNCED
  ,OMS."Total Bounce Impact" AS TOTAL_BOUNCE_IMPACT
  ,OMS."Bad Bounced" AS BAD_BOUNCED
  ,OMS."Bounce Count" AS BOUNCE_COUNT
  ,OMS."Bad Bounce Count" AS BAD_BOUNCE_COUNT

-- CONTRACT INFO
  ,CASE WHEN OMS."CONTRACT KEY" IS NULL THEN MEG.CONTRACT_ID ELSE OMS."CONTRACT KEY" END AS CONTRACT_KEY
  ,MEG.NEW_REPORTING_CONCAT AS CONTRACT_DETAILS
  ,MEG.OWNED_OR_UNOWNED_CONTRACT AS CONTRACT_TYPE
  ,CASE WHEN CARRIER_OWNERS.CARRIER IS NULL THEN MEG.CARRIER_NAME ELSE CARRIER_OWNERS.CARRIER END AS MEG_CARRIER_NAME
  ,MEG.CARRIER_DOT AS MEG_CARRIER_DOT
  ,MEG.EFFECTIVE_CONTRACT_START_DATE
  ,MEG.EFFECTIVE_CONTRACT_END_DATE
  ,MEG.CMP_ID
  ,CASE WHEN MEG.SOURCING_TEAM IS NULL THEN CARRIER_OWNERS.CARRIER_OWNER ELSE MEG.SOURCING_TEAM END AS CARRIER_OWNER
  ,MEG.OPERATIONAL_PREFERENCES_NOTES AS REPORTING_NOTES
  ,CASE WHEN GETDATE()<=EFFECTIVE_CONTRACT_END_DATE THEN TRUE ELSE FALSE END AS CONTRACT_LIVE
  ,MEG.LPD
  ,MEG.VOLUME
  ,MEG.FREQUENCY
  ,MEG.CONTRACT_TERMINATED AS TERMINATED
  ,MEG.CONTRACT_TERMINATION_REASON_CODE
  ,MEG.NOTES
  ,MEG.CARRIER_RATE
  ,MEG.RATE_TYPE
  ,ROUND(MEG.TOTAL_CONTRACT_VOLUME,2) AS TOTAL_ESTIMATED_VOLUME
  ,ROUND(MEG.ESTIMATED_TOTAL_REVENUE,2) AS TOTAL_ESTIMATED_REVENUE
  ,ROUND(MEG.ESTIMATED_TOTAL_GP,2) AS TOTAL_ESTIMATED_GP
  ,MEG.SHIPPER_NAME AS CONTRACT_SHIPPER_NAME
  ,SCHEDULED_CONTRACT_START_DATE
  ,SCHEDULED_CONTRACT_END_DATE

-- EXECUTION INFO
  ,CASE WHEN PICKUP_DATE <= EFFECTIVE_CONTRACT_END_DATE AND PICKUP_DATE >= EFFECTIVE_CONTRACT_START_DATE
    THEN TRUE ELSE FALSE
    END AS WITHIN_CONTRACT_DATES
  ,CASE WHEN OMS."Dot Number" = CARRIER_DOT THEN TRUE ELSE FALSE END AS CONTRACT_CARRIER_FULFILLED

-- COMMISSION INFO (MAYBE REMOVE AND PUT INTO COMMISSION QUERY SPECIFICALLY)
  ,CASE WHEN WITHIN_CONTRACT_DATES = TRUE AND CONTRACT_CARRIER_FULFILLED = TRUE AND OMS."Gp" < 0 THEN 1 ELSE 0 END AS GP_LOSS_PAYOUT
  ,CASE WHEN "Gp"<0 AND WITHIN_CONTRACT_DATES = TRUE AND CONTRACT_CARRIER_FULFILLED = TRUE THEN 0 ELSE "Gp" END AS GP_MOD
  
FROM MEG
LEFT JOIN OMS ON MEG.CONTRACT_ID = OMS."CONTRACT KEY"
LEFT JOIN CARRIER_OWNERS ON TO_NUMBER(MEG.CARRIER_DOT) = CARRIER_OWNERS.DOT AND CARRIER_OWNERS.CARRIER_OWNER IS NOT NULL
    AND TRANSPORTATION_ENTITY_KEY NOT IN (
      1797726  -- THERE ARE TWO ENTITIES FOR AMAZON DOT#, REMOVE THIS ONE
      ,29133 -- DUPE FOR SPARHAWK TRUCKING, INC.
      )
WHERE 1=1

-- AND CONTRACT_KEY = 'C26A788F-6EB1-44A7-8957-E9A62545F340-2881058'
-- AND OMS."S Number" IS NULL
-- AND OMS."S Number" IN('S111810388')
-- AND DOT_NUMBER IS NULL
